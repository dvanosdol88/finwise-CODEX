name: Monday Dependency Report

on:
  schedule:
    # Every Monday at 9:00 AM Eastern (14:00 UTC)
    - cron: '0 14 * * 1'
  workflow_dispatch: # Allows manual trigger for testing

jobs:
  dependency-report:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Dependency Dashboard
        id: dashboard
        uses: actions/github-script@v7
        with:
          script: |
            // Find the Dependency Dashboard issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: 'renovate[bot]',
              state: 'open',
              per_page: 10
            });
            
            const dashboard = issues.data.find(i => 
              i.title.includes('Dependency Dashboard')
            );
            
            if (!dashboard) {
              core.setOutput('found', 'false');
              core.setOutput('summary', 'No Dependency Dashboard found. Renovate may not be configured.');
              return;
            }
            
            core.setOutput('found', 'true');
            core.setOutput('url', dashboard.html_url);
            core.setOutput('body', dashboard.body);
            
            // Parse the dashboard for pending updates
            const body = dashboard.body || '';
            
            // Count unchecked items (pending approvals)
            const pendingApprovals = (body.match(/- \[ \]/g) || []).length;
            const openPRs = (body.match(/- \[x\]/g) || []).length;
            
            // Check for rate-limited or errored items
            const hasErrors = body.includes('‚ö†') || body.includes('‚ùå');
            const hasRateLimited = body.toLowerCase().includes('rate-limited');
            
            // Build summary
            let summary = `üìä *Dependency Dashboard Summary*\n\n`;
            summary += `‚Ä¢ Awaiting Approval: *${pendingApprovals}* updates\n`;
            summary += `‚Ä¢ Open PRs: *${openPRs}* in progress\n`;
            
            if (hasErrors) {
              summary += `‚Ä¢ ‚ö†Ô∏è *Errors detected* - check dashboard\n`;
            }
            if (hasRateLimited) {
              summary += `‚Ä¢ üê¢ Some updates are rate-limited\n`;
            }
            
            if (pendingApprovals === 0 && !hasErrors) {
              summary += `\n‚úÖ *All clear!* No action needed this week.`;
            } else if (pendingApprovals > 0) {
              summary += `\nüëâ <${dashboard.html_url}|Open Dashboard> to review.`;
            }
            
            core.setOutput('summary', summary);
            core.setOutput('pending', pendingApprovals.toString());

      - name: Send to Slack
        if: always()
        uses: slackapi/slack-github-action@v1.27.1
        with:
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üóìÔ∏è Monday Dependency Report",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{ toJSON(steps.dashboard.outputs.summary) }}
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "Repo: ${{ github.repository }} | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
